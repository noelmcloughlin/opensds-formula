### opensds/map.jinja ###
### exported dicts: opensds, driver, docker, firewalld, golang, ceph, devstack ###

#OpenSDS: import formula default dicts
{% import_yaml "opensds/envs/defaults.yaml" as envs %}
{% import_yaml "opensds/envs/devstack/defaults.yaml" as devstack %}
{% import_yaml "opensds/defaults.yaml" as defaults %}
{% import_yaml "opensds/controller/defaults.yaml" as controller %}
{% import_yaml "opensds/auth/defaults.yaml" as auth %}
{% import_yaml "opensds/dashboard/defaults.yaml" as dashboard %}
{% import_yaml "opensds/database/defaults.yaml" as database %}
{% import_yaml "opensds/dock/defaults.yaml" as dock %}
{% import_yaml "opensds/dock/block/defaults.yaml" as block %}
{% import_yaml "opensds/let/defaults.yaml" as let %}
{% import_yaml "opensds/nbp/defaults.yaml" as nbp %}
{% import_yaml "opensds/osfamilymap.yaml" as osfamilymap %}
{% import_yaml "opensds/osmap.yaml" as osmap %}

#OpenSDS: merge any pillar data with defaults
{%- set opensds = salt['grains.filter_by'](
     defaults, merge=salt['grains.filter_by'](
        controller, merge=salt['grains.filter_by'](
           auth, merge=salt['grains.filter_by'](
              dashboard, merge=salt['grains.filter_by'](
                 database, merge=salt['grains.filter_by'](
                    dock, merge=salt['grains.filter_by'](
                       block, merge=salt['grains.filter_by'](
                          let, merge=salt['grains.filter_by'](
                             nbp, merge=salt['grains.filter_by'](
                                envs, merge=salt['grains.filter_by'](
                                   osfamilymap, grain='os_family', merge=salt['grains.filter_by'](
                                      osmap, grain='os', merge=salt['pillar.get']('opensds', {}),
                                      base='opensds',),
                                   base='opensds',),
                                base='opensds',),
                             base='opensds',),
                          base='opensds',),
                       base='opensds',),
                    base='opensds',),
                 base='opensds',),
              base='opensds',),
           base='opensds',),
        base='opensds',),
     base='opensds',)
%}

# Third-party: merge any pillar data with defaults
{%- set firewalld = salt['grains.filter_by']( envs.firewalld, merge=salt['pillar.get']('firewalld', {}), base='firewalld') %}
{%- set golang = salt['grains.filter_by']( envs.golang, merge=salt['pillar.get']('golang', {}), base='golang') %}
{%- set ceph = salt['grains.filter_by']( envs.ceph, merge=salt['pillar.get']('ceph', {}), base='ceph') %}
{%- set docker = salt['grains.filter_by']( envs.docker, merge=salt['pillar.get']('docker', {}), base='docker') %}
{%- set devstack = salt['grains.filter_by']( devstack, merge=salt['pillar.get']('devstack', {}), base='devstack') %}

# DRIVER: merge any pillar data with, and over, defaults
{% from "opensds/files/macros.jinja" import deep_merge with context %}
{%- import_yaml 'opensds/dock/drivers/' ~ opensds.dock.block.provider ~ '.yaml' as driver %}
{%- do deep_merge(driver, opensds.driver) %}

# SITE SPECIFIC PARAM INJECTION
{%- if opensds.dock.block.provider in ('lvm',) %}
  {%- do driver.update({'tgtBindIp': opensds.host or '127.0.0.1'}) %}
{%- endif %}
